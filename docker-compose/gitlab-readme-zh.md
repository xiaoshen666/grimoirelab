# 个人访问令牌

## 等级：免费版、高级版、旗舰版

## 适用产品：GitLab.com、自托管 GitLab、专属 GitLab

个人访问令牌可作为 OAuth2 的替代方案，用于：

- 通过 GitLab API 进行身份验证
- 使用 HTTP 基本认证通过 Git 进行身份验证

在这两种情况下，您使用个人访问令牌代替密码进行身份验证。用户名不会作为身份验证过程的一部分进行验证。

### 个人访问令牌的特点：

- 当启用双因素认证(2FA)或 SAML 时必须使用
- 与 GitLab 用户名配合使用，用于需要用户名的 GitLab 功能认证（例如 GitLab 管理的 Terraform 状态后端和 Docker 容器注册表）
- 类似于项目访问令牌和组访问令牌，但附加到用户而非项目或组
- 虽然需要用户名，但在使用个人访问令牌进行身份验证时会被忽略。目前有一个问题跟踪记录，使 GitLab 能够使用用户名

有关如何使用个人访问令牌通过 API 进行身份验证的示例，请参阅 API 文档。

另外，GitLab 管理员可以使用 API 创建模拟令牌。使用模拟令牌可以自动以特定用户身份进行身份验证。

## 创建个人访问令牌

### 历史记录

扩展最大允许生命周期限制的可用性由功能标志控制。更多信息请参见历史记录。

在 GitLab 15.4 中弃用了创建无过期日期的个人访问令牌的功能，并在 GitLab 16.0 中移除了该功能。有关个人访问令牌何时过期以及现有令牌添加过期日期的信息，请参阅有关访问令牌过期的文档。

您可以创建任意数量的个人访问令牌。

操作步骤：

1. 在左侧边栏中，选择您的头像
2. 选择"编辑个人资料"
3. 在左侧边栏中，选择"访问令牌"
4. 选择"添加新令牌"
5. 在"令牌名称"中，输入令牌的名称
6. 可选：在"令牌描述"中，输入令牌的描述
7. 在"过期日期"中，输入令牌的过期日期
   - 令牌将在该日期的 UTC 午夜过期。例如，过期日期为 2024-01-01 的令牌将在 2024-01-01 00:00:00 UTC 过期
   - 如果不输入过期日期，过期日期将自动设置为当前日期之后 365 天
   - 默认情况下，此日期最多可比当前日期晚 365 天。在 GitLab 17.6 或更高版本中，可以将此限制延长至 400 天
8. 选择所需的权限范围
9. 选择"创建个人访问令牌"

请将个人访问令牌保存在安全的地方。离开页面后，您将无法再次访问该令牌。

### 预填充个人访问令牌详细信息

您可以通过将名称、描述和权限范围列表附加到 URL 来预填充个人访问令牌的详细信息。例如：

复制

```
https://gitlab.example.com/-/user_settings/personal_access_tokens?name=Example+Access+token&description=My+description&scopes=api,read_user
```

个人访问令牌必须谨慎处理。阅读我们的令牌安全考虑指南，了解如何管理个人访问令牌（例如，设置较短的过期时间和使用最小权限范围）。

## 撤销或轮换个人访问令牌

### 历史记录

您随时可以使用用户界面撤销个人访问令牌，或者在 GitLab 17.7 及更高版本中轮换个人访问令牌。

操作步骤：

1. 在左侧边栏中，选择您的头像
2. 选择"编辑个人资料"
3. 在左侧边栏中，选择"访问令牌"
4. 在活动令牌旁边，选择垂直省略号(⋮)
5. 选择"撤销"(🗑️)或"轮换"(🔁)
6. 在确认对话框中，选择"撤销"或"轮换"

这些操作不可撤销。任何依赖于已撤销或轮换访问令牌的工具都将停止工作。

## 禁用个人访问令牌

### 等级：高级版、旗舰版

### 适用产品：自托管 GitLab、专属 GitLab

### 前提条件：

- 您必须是管理员
- 根据您的 GitLab 版本，您可以使用应用程序设置 API 或管理员用户界面来禁用个人访问令牌

### 使用应用程序设置 API

在 GitLab 15.7 及更高版本中，您可以在应用程序设置 API 中使用 `disable_personal_access_tokens` 属性来禁用个人访问令牌。

使用 API 禁用个人访问令牌后，这些令牌不能在后续 API 调用中用于管理此设置。要重新启用个人访问令牌，您必须使用 GitLab Rails 控制台。您也可以升级到 GitLab 17.3 或更高版本，以便可以使用管理员用户界面。

### 使用管理员用户界面

在 GitLab 17.3 及更高版本中，您可以使用管理员用户界面来禁用个人访问令牌：

1. 在左侧边栏底部，选择"管理员"
2. 选择"设置">"常规"
3. 展开"可见性和访问控制"
4. 选中"禁用个人访问令牌"复选框
5. 选择"保存更改"

## 为企业用户禁用个人访问令牌

### 前提条件：

- 您必须是企业用户所属组的拥有者角色

禁用企业用户的个人访问令牌：

- 阻止企业用户创建新的个人访问令牌。即使企业用户也是组的管理员，此行为也适用
- 禁用企业用户现有的个人访问令牌
- 禁用企业用户的个人访问令牌不会禁用服务账户的个人访问令牌

操作步骤：

1. 在左侧边栏中，选择"搜索"或"前往"并找到您的组
2. 选择"设置">"常规"
3. 展开"权限和组功能"
4. 在"个人访问令牌"下，选择"禁用个人访问令牌"
5. 选择"保存更改"

当您删除或阻止企业用户帐户时，他们的个人访问令牌将自动被撤销。

## 查看令牌使用信息

### 历史记录

令牌使用信息会定期更新。令牌上次使用的时间每 10 分钟更新一次，最近使用的 IP 地址每分钟更新一次。GitLab 认为令牌被使用的情况包括：

- 使用 REST 或 GraphQL API 进行身份验证
- 执行 Git 操作

查看令牌上次使用的时间和令牌使用的 IP 地址：

1. 在左侧边栏中，选择您的头像
2. 选择"编辑个人资料"
3. 在左侧边栏中，选择"访问令牌"
4. 在"活动个人访问令牌"区域，查看相关令牌的"上次使用日期"和"上次使用 IP"。最近使用的 IP 显示最后五个不同的 IP 地址。

## 个人访问令牌权限范围

### 历史记录

个人访问令牌可以根据分配的权限范围执行操作。

|        权限范围        |                           访问权限                           |
| :--------------------: | :----------------------------------------------------------: |
|          api           | 授予对 API 的完全读写访问权限，包括所有组和项目、容器注册表、依赖代理和包注册表。还授予通过 HTTP 使用 Git 对注册表和仓库的完全读写访问权限 |
|       read_user        | 通过 /user API 端点授予对经过身份验证的用户个人资料的只读访问权限，包括用户名、公开电子邮件和全名。还授予对 /users 下的只读 API 端点的访问权限 |
|        read_api        | 授予对 API 的读取访问权限，包括所有组和项目、容器注册表和包注册表 |
|    read_repository     | 授予通过 Git-over-HTTP 或仓库文件 API 对私有项目仓库的只读访问权限 |
|    write_repository    | 授予通过 Git-over-HTTP（不使用 API）对私有项目仓库的读写访问权限 |
|     read_registry      | 如果项目是私有的且需要授权，则授予对容器注册表镜像的只读（拉取）访问权限。仅在启用容器注册表时可用 |
|     write_registry     | 如果项目是私有的且需要授权，则授予对容器注册表镜像的读写（推送）访问权限。仅在启用容器注册表时可用 |
| read_virtual_registry  | 如果项目是私有的且需要授权，则通过依赖代理授予对容器镜像的只读（拉取）访问权限。仅在启用依赖代理时可用 |
| write_virtual_registry | 如果项目是私有的且需要授权，则通过依赖代理授予对容器镜像的读取（拉取）、写入（推送）和删除访问权限。仅在启用依赖代理时可用 |
|          sudo          | 当作为管理员身份验证时，授予以系统中任何用户身份执行 API 操作的权限 |
|       admin_mode       | 授予在启用管理员模式时执行 API 操作的权限。GitLab 15.8 中引入。仅适用于自托管 GitLab 实例的管理员 |
|     create_runner      |                     授予创建运行器的权限                     |
|     manage_runner      |                     授予管理运行器的权限                     |
|      ai_features       |                           此范围：                           |

- 授予对 GitLab Duo、代码建议 API 和 Duo Chat API 等功能的 API 操作权限
- 不适用于 GitLab 自托管版本 16.5、16.6 和 16.7
- 对于 JetBrains 的 GitLab Duo 插件：
  - 支持在 JetBrains 的 GitLab Duo 插件中启用了 AI 功能的用户
  - 解决 JetBrains IDE 插件中可能导致个人访问令牌泄露的安全漏洞
  - 旨在通过限制受损令牌的影响来最小化 GitLab Duo 插件用户的潜在风险
- 对于所有其他扩展，请参阅其文档中的各个范围要求 |
  | k8s_proxy | 授予使用 Kubernetes 代理执行 Kubernetes API 调用的权限 |
  | self_rotate | 授予使用个人访问令牌 API 轮换此令牌的权限。不允许轮换其他令牌 |
  | read_service_ping | 当作为管理员身份验证时，通过 API 下载服务 Ping 负载的访问权限 |

如果您启用了外部授权，个人访问令牌将无法访问容器或包注册表。如果您使用个人访问令牌访问这些注册表，此措施将中断这些令牌的使用。要使用个人访问令牌访问容器或包注册表，请禁用外部授权。

## 访问令牌过期

### 历史记录

扩展最大允许生命周期限制的可用性由功能标志控制。更多信息请参见历史记录。

个人访问令牌会在您定义的日期的午夜（UTC 时间 00:00）过期。例如，过期日期为 2024-01-01 的令牌将在 2024-01-01 00:00:00 UTC 过期。

GitLab 每天 UTC 时间 01:00 运行一次检查，以识别即将过期的个人访问令牌。这些令牌的所有者会通过电子邮件收到通知。

GitLab 每天 UTC 时间 02:00 运行一次检查，以识别当天过期的个人访问令牌。这些令牌的所有者会通过电子邮件收到通知。

在 GitLab Ultimate 中，管理员可以限制访问令牌的允许生命周期。如果未设置，个人访问令牌的最大允许生命周期为 365 天。在 GitLab 17.6 或更高版本中，可以将此限制延长至 400 天。

在 GitLab 免费版和高级版中，个人访问令牌的最大允许生命周期为 365 天。在 GitLab 17.6 或更高版本中，可以将此限制延长至 400 天。

如果您在创建个人访问令牌时未设置过期日期，过期日期将设置为令牌的最大允许生命周期。如果未设置最大允许生命周期，默认过期日期为创建日期之后的 365 天。

您现有的个人访问令牌是否自动应用过期日期取决于您使用的 GitLab 产品以及您升级到 GitLab 16.0 或更高版本的时间：

- 在 GitLab.com 上，在 16.0 版本里程碑期间，没有过期日期的现有个人访问令牌会自动获得比当前日期晚 365 天的过期日期
- 在自托管 GitLab 上，如果您从 GitLab 15.11 或更早版本升级到 GitLab 16.0 或更高版本：
  - 在 2024 年 7 月 23 日或之前，没有过期日期的现有个人访问令牌会自动获得比当前日期晚 365 天的过期日期。这是一个破坏性变更
  - 在 2024 年 7 月 24 日或之后，没有过期日期的现有个人访问令牌不会被设置过期日期
- 在自托管 GitLab 上，如果您安装了以下 GitLab 版本之一的新实例，您现有的个人访问令牌不会自动应用过期日期：
  - 16.0.9
  - 16.1.7
  - 16.2.10
  - 16.3.8
  - 16.4.6
  - 16.5.9
  - 16.6.9
  - 16.7.9
  - 16.8.9
  - 16.9.10
  - 16.10.9
  - 16.11.7
  - 17.0.5
  - 17.1.3
  - 17.2.1

## 访问令牌过期电子邮件

### 历史记录

GitLab 每天 UTC 时间 01:00 运行一次检查，以识别即将过期的个人访问令牌。当这些令牌在特定天数后过期时，其所有者会通过电子邮件收到通知。具体天数取决于 GitLab 的版本：

- 在 GitLab 17.6 及更高版本中，当检查发现个人访问令牌将在未来 60 天内过期时，令牌所有者会通过电子邮件收到通知。当检查发现组访问令牌将在未来 30 天内过期时，会发送额外电子邮件
- 当检查发现组访问令牌将在未来七天内过期时，个人访问令牌所有者会通过电子邮件收到通知

## 个人访问令牌过期日历

您可以订阅一个 iCalendar 端点，其中包含每个令牌到期日期的事件。登录后，此端点可在 /-/user_settings/personal_access_tokens.ics 访问。

## 创建无过期日期的服务账户个人访问令牌

您可以为服务账户创建无过期日期的个人访问令牌。与普通个人访问令牌不同，这些个人访问令牌永不过期。

允许为服务账户创建无过期日期的个人访问令牌只会影响在该设置更改后创建的令牌。它不会影响现有令牌。

### GitLab.com

### 前提条件：

- 您必须拥有顶级组的拥有者角色

操作步骤：

1. 在左侧边栏中，选择"搜索"或"前往"并找到您的组
2. 选择"设置">"常规">"权限和组功能"
3. 清除"服务账户令牌过期"复选框
4. 现在您可以为服务账户用户创建无过期日期的个人访问令牌

### 自托管 GitLab

### 前提条件：

- 您必须是自托管 GitLab 实例的管理员

操作步骤：

1. 在左侧边栏底部，选择"管理员"
2. 选择"设置">"常规"
3. 展开"账户和限制"
4. 清除"服务账户令牌过期"复选框
5. 现在您可以为服务账户用户创建无过期日期的个人访问令牌

## 使用 DPoP 与个人访问令牌

### 等级：免费版、高级版、旗舰版

### 适用产品：GitLab.com、自托管 GitLab

### 历史记录

此功能的可用性由功能标志控制。更多信息请参见历史记录。此功能可用于测试，但尚未准备好投入生产使用。

证明持有权(DPoP)增强了个人访问令牌的安全性，并最大限度地减少了意外令牌泄露的影响。当您在账户上启用此功能时，所有包含 PAT 的 REST 和 GraphQL API 请求还必须提供签名的 DPoP 标头。创建签名的 DPoP 标头需要您相应的私钥 SSH 密钥。

如果启用此功能，所有不包含有效 DPoP 标头的 API 请求将返回 DpopValidationError 错误。

对于通过 HTTPS 包含访问令牌的 Git 操作，不需要 DPoP 标头。

### 前提条件：

- 您必须向账户添加至少一个公钥 SSH 密钥，使用类型为"签名"或"认证和签名"
- 您的 SSH 密钥类型必须是 RSA
- 您必须已安装并为 GitLab 账户配置了 GitLab CLI

要要求对所有 REST 和 GraphQL API 调用使用 DPoP：

1. 在左侧边栏中，选择您的头像
2. 选择"编辑个人资料"
3. 在左侧边栏中，选择"访问令牌"
4. 转到"使用证明持有权(DPoP)"部分，选择"启用 DPoP"
5. 选择"保存更改"

要使用 GitLab CLI 生成 DPoP 标头，请在终端中运行以下命令。将 `<your_access_token>` 替换为您的访问令牌，将 `~/.ssh/id_rsa` 替换为您的私钥位置：

shell

复制

```
glab auth dpop-gen --pat "<your_access_token>" --private-key ~/.ssh/id_rsa
```

您在 CLI 中生成的 DPoP 标头可用于：

- 与 REST API 一起使用：

shell

复制

```
curl --header "Private-Token: <your_access_token>" \
  --header "DPoP: <dpop-from-glab>" \
  "https://gitlab.example.com/api/v4/projects"
```

- 与 GraphQL 一起使用：

shell

复制

```
curl --request POST \
 --header "Content-Type: application/json" \
 --header "Private-Token: <your_access_token>" \
 --header "DPoP: <dpop-from-glab>" \
 --data '{
 "query": "query { currentUser { id } }"
 }' \
 "https://gitlab.example.com/api/graphql"
```

要了解有关 DPoP 的更多信息，请参阅蓝图"限制个人访问令牌的发送者"。

## 以编程方式创建个人访问令牌

### 等级：免费版、高级版、旗舰版

### 适用产品：自托管 GitLab、专属 GitLab

您可以在测试或自动化过程中创建预定的个人访问令牌。

### 前提条件：

- 您需要有足够的权限为 GitLab 实例运行 Rails 控制台会话

### 操作步骤：

1. 打开 Rails 控制台：

shell

复制

```
sudo gitlab-rails console
```

1. 运行以下命令来引用用户名、令牌和权限范围。

令牌必须是 20 个字符长。权限范围必须是有效的，并且可以在源代码中看到。

例如，要创建一个属于用户名为 automation-bot 的用户且一年后过期的令牌：

ruby

复制

```
user = User.find_by_username('automation-bot')
token = user.personal_access_tokens.create(scopes: ['read_user', 'read_repository'], name: 'Automation token', expires_at: 365.days.from_now)
token.set_token('token-string-here123')
token.save!
```

此代码可以使用 Rails runner 缩短为单行 shell 命令：

shell

复制

```
sudo gitlab-rails runner "token = User.find_by_username('automation-bot').personal_access_tokens.create(scopes: ['read_user', 'read_repository'], name: 'Automation token', expires_at: 365.days.from_now); token.set_token('token-string-here123'); token.save!"
```

## 以编程方式撤销个人访问令牌

### 等级：免费版、高级版、旗舰版

### 适用产品：自托管 GitLab、专属 GitLab

您可以在测试或自动化过程中以编程方式撤销个人访问令牌。

### 前提条件：

- 您需要有足够的权限为 GitLab 实例运行 Rails 控制台会话

### 操作步骤：

1. 打开 Rails 控制台：

shell

复制

```
sudo gitlab-rails console
```

1. 要撤销令牌 `token-string-here123`，运行以下命令：

ruby

复制

```
token = PersonalAccessToken.find_by_token('token-string-here123')
token.revoke!
```

此代码可以使用 Rails runner 缩短为单行 shell 命令：

shell

复制

```
sudo gitlab-rails runner "PersonalAccessToken.find_by_token('token-string-here123').revoke!"
```

## 使用个人访问令牌克隆仓库

### 等级：免费版、高级版、旗舰版

### 适用产品：自托管 GitLab、专属 GitLab

当 SSH 被禁用时，可以使用个人访问令牌通过以下命令克隆仓库：

shell

复制

```
git clone https://<username>:<personal_token>@gitlab.com/gitlab-org/gitlab.git
```

此方法会将您的个人访问令牌保存在 bash 历史记录中。要避免这种情况，请运行以下命令：

shell

复制

```
git clone https://<username>@gitlab.com/gitlab-org/gitlab.git
```

当系统要求输入 https://gitlab.com 的密码时，输入您的个人访问令牌。

克隆命令中的用户名：

- 可以是任何字符串值
- 不能为空字符串

如果您设置了依赖身份验证的自动化流水线，请记住这一点。

## 故障排除

### 撤销个人访问令牌

### 等级：免费版、高级版、旗舰版

### 适用产品：自托管 GitLab、专属 GitLab

如果个人访问令牌因任何方法被意外撤销，管理员可以恢复该令牌。默认情况下，每天系统会在 UTC 时间 01:00 运行一个作业来删除已撤销的令牌。

运行以下命令会直接更改数据。如果操作不正确或在适当条件下，可能会造成损害。您应该首先在测试环境中运行这些命令，并准备好实例备份以便在需要时恢复。

1. 打开 Rails 控制台
2. 恢复令牌：

ruby

复制

```
token = PersonalAccessToken.find_by_token('<token_string>')
token.update!(revoked:false)
```

例如，要恢复令牌 `token-string-here123`：

ruby

复制

```
token = PersonalAccessToken.find_by_token('token-string-here123')
token.update!(revoked:false)
```

### 个人访问令牌的替代方案

对于通过 HTTPS 的 Git，个人访问令牌的替代方案是使用 OAuth 凭据助手。

## 帮助与反馈
